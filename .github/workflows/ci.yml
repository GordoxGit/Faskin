name: Java CI (Gradle)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Set up Gradle
        uses: gradle/gradle-build-action@v3
        with:
          gradle-version: '8.14.3'

      - name: Show gradle version
        run: gradle --version

      - name: Validate plugin.yml (encoding/format)
        run: |
          file -bi src/main/resources/plugin.yml | grep -qi 'charset=utf-8' || { echo "plugin.yml not UTF-8"; exit 1; }
          grep -nP '\\t' src/main/resources/plugin.yml && { echo "Tabs found in plugin.yml"; exit 1; } || true
          python - <<'PY'
import yaml
with open('src/main/resources/plugin.yml', 'rb') as f:
    data = f.read().lstrip(b"\xef\xbb\xbf")
    yaml.safe_load(data.decode('utf-8'))
print('YAML OK')
PY

      - name: Validate commands presence
        run: |
          set -e
          CMDS=$( { grep -R --line-number 'getCommand("' src/main/java || true; grep -R --line-number 'bind("' src/main/java || true; } | sed -E 's/.*(getCommand|bind)\("([^"]+)".*/\2/' | sort -u )
          echo "Code expects commands: $CMDS"
          for c in $CMDS; do
            if ! awk '/^commands:/{f=1;next} f&&/^[^[:space:]]/{f=0} f{print}' src/main/resources/plugin.yml | grep -qE "^[[:space:]]+$c:" ; then
              echo "::error::Command '$c' not declared under 'commands:' in plugin.yml"
              exit 1
            fi
          done
          echo "Commands validation OK"

      - name: Build
        run: gradle clean build --no-daemon -Dorg.gradle.jvmargs="-Xmx2g"
